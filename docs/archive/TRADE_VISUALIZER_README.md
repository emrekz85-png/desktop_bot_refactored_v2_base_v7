# Trade Visualization System

Professional TradingView-style chart visualization for Rolling Walk-Forward backtest trades.

## Overview

The Trade Visualization System creates high-quality candlestick charts with technical indicators to help diagnose why individual trades succeed or fail. This is a critical tool for:

- Validating strategy logic
- Identifying entry/exit quality
- Understanding indicator behavior at trade time
- Debugging failed trades
- Building confidence in profitable trades

## Features

### Chart Components

**Main Panel:**
- Professional dark theme (TradingView style)
- Candlestick price action with up/down coloring
- SSL Baseline (HMA 60) - blue line
- PBEMA Cloud (EMA 200) - purple shaded area
- Entry marker: Green arrow up (LONG) / Red arrow down (SHORT)
- Exit marker: Star (TP hit) / X (SL hit)
- TP level: Horizontal green dashed line
- SL level: Horizontal red dashed line
- Trade zone: Shaded rectangle (green for win, red for loss)

**Subplots:**
- RSI(14) with 30/70 overbought/oversold zones
- ADX(14) with 25 trend strength threshold
- Volume bars (colored by candle direction)

**Info Panel:**
- Symbol, timeframe, trade type
- Entry/exit times and prices
- TP/SL levels
- PnL and R-multiple
- Trade result (WIN/LOSS)

## Installation

No additional dependencies required beyond the main project requirements:

```bash
# Already installed with main project
pip install -r requirements.txt
```

Required libraries:
- pandas
- numpy
- matplotlib
- pandas_ta (for indicators)
- requests (for Binance API)

## Usage

### Basic Commands

```bash
# Visualize a specific trade by number
python run_trade_visualizer.py \
    --file data/rolling_wf_runs/.../trades_detailed.txt \
    --trade 5

# Visualize all trades (batch mode)
python run_trade_visualizer.py \
    --file data/rolling_wf_runs/.../trades_detailed.txt \
    --all

# Interactive browser mode
python run_trade_visualizer.py \
    --file data/rolling_wf_runs/.../trades_detailed.txt \
    --browse
```

### Advanced Options

```bash
# Custom output directory
python run_trade_visualizer.py \
    --file trades_detailed.txt \
    --all \
    --output my_charts/

# Adjust chart window (candles before/after trade)
python run_trade_visualizer.py \
    --file trades_detailed.txt \
    --trade 1 \
    --candles-before 100 \
    --candles-after 50

# Change resolution (default: 300 DPI)
python run_trade_visualizer.py \
    --file trades_detailed.txt \
    --all \
    --dpi 150
```

### Command-Line Arguments

| Argument | Short | Description | Default |
|----------|-------|-------------|---------|
| `--file` | `-f` | Path to trades_detailed.txt (required) | - |
| `--trade` | `-t` | Specific trade number to visualize | - |
| `--all` | `-a` | Visualize all trades | False |
| `--browse` | `-b` | Interactive browser mode | False |
| `--output` | `-o` | Output directory for charts | `trade_charts/` |
| `--candles-before` | - | Candles before entry | 75 |
| `--candles-after` | - | Candles after exit | 35 |
| `--dpi` | - | Chart resolution | 300 |

## File Structure

```
desktop_bot_refactored_v2_base_v7/
├── core/
│   └── trade_visualizer.py      # Main visualization engine
├── run_trade_visualizer.py      # CLI runner script
├── trade_charts/                # Output directory (auto-created)
│   ├── BTCUSDT_15m_..._WIN.png
│   └── ETHUSDT_15m_..._LOSS.png
└── TRADE_VISUALIZER_README.md   # This file
```

## Input Data Format

The visualizer parses `trades_detailed.txt` files generated by Rolling Walk-Forward tests.

**Expected format:**
```
┌─ Trade #1 ─────────────────────────────────────────────────────────┐
│  ✅ WIN                                                             │
│                                                                     │
│  Symbol:     BTCUSDT-15m                                           │
│  Type:       LONG                                                  │
│  Entry Time: 2025-08-13T21:30:00Z                                  │
│  Entry:      $42,500.00                                            │
│  TP Target:  $43,350.00                                            │
│  SL Target:  $42,075.00                                            │
│  Exit Time:  2025-08-14T05:30:00Z                                  │
│  Exit Price: $43,350.00 (TP HIT)                                   │
│  PnL:        $+35.50                                               │
│  R-Multiple: +2.0                                                  │
│                                                                     │
│  ─── Indicators at Entry ───                                       │
│  AT Buyers:     42,300.70                                          │
│  AT Sellers:    42,100.50                                          │
│  Baseline:      42,400.00                                          │
│  PBEMA Top:     43,200.00                                          │
│  RSI:           55.0                                               │
│  ADX:           28.0                                               │
└─────────────────────────────────────────────────────────────────────┘
```

## Examples

### Example 1: Quick Single Trade Visualization

```bash
# Visualize the first trade from a recent run
python run_trade_visualizer.py \
    --file data/rolling_wf_runs/v1.7.2_20251228_004201_5b2cfac2/trades_detailed.txt \
    --trade 1
```

**Output:**
```
Loading trades from data/rolling_wf_runs/.../trades_detailed.txt...
Found 25 trades

Visualizing trade #1:
  BTCUSDT-15m SHORT @ 2025-08-13T21:30:00Z
  PnL: $-20.46 | R: -1.17x | LOST

Chart saved: trade_charts/BTCUSDT_15m_20250813T2130_SHORT_LOSS.png
```

### Example 2: Batch Process All Trades

```bash
# Generate charts for all trades in a run
python run_trade_visualizer.py \
    --file data/rolling_wf_runs/v1.7.2_20251228_004201_5b2cfac2/trades_detailed.txt \
    --all
```

**Output:**
```
Loading trades from trades_detailed.txt...
Found 25 trades

Visualizing all 25 trades...
Processing trade 25/25...

Successfully visualized 25/25 trades

Done! Generated 25 charts in trade_charts/
```

### Example 3: Interactive Browser

```bash
# Browse trades interactively
python run_trade_visualizer.py \
    --file data/rolling_wf_runs/.../trades_detailed.txt \
    --browse
```

**Output:**
```
================================================================================
#    Symbol          Type   Entry Time           PnL        R      Result
================================================================================
1    BTCUSDT-15m     SHORT  2025-08-13T21:30:00Z $-20.46    -1.17x LOST
2    BTCUSDT-15m     SHORT  2025-08-14T01:00:00Z $+5.83     +1.02x WON
3    BTCUSDT-15m     SHORT  2025-08-22T19:00:00Z $+14.32    +1.58x WON
...
================================================================================

Enter trade number to visualize (or 'q' to quit): 2

Visualizing trade #2...
Chart saved: trade_charts/BTCUSDT_15m_20250814T0100_SHORT_WIN.png

Enter trade number to visualize (or 'q' to quit): q
Exiting...
```

## Chart Interpretation Guide

### SSL Flow Strategy

The SSL Flow strategy uses SSL Baseline + PBEMA Cloud for trade entry/exit:

**LONG Entry:**
1. Price touches SSL Baseline from above (retest)
2. AlphaTrend shows BUYERS dominant
3. PBEMA Cloud is above (room for profit)
4. RSI not overbought

**SHORT Entry:**
1. Price touches SSL Baseline from below (retest)
2. AlphaTrend shows SELLERS dominant
3. PBEMA Cloud is below (room for profit)
4. RSI not oversold

**Take Profit:**
- LONG: PBEMA bottom (EMA 200 close)
- SHORT: PBEMA top (EMA 200 high)

**Stop Loss:**
- LONG: Min(swing low, baseline) - 0.2%
- SHORT: Max(swing high, baseline) + 0.2%

### What to Look For

**Winning Trades:**
- Clean baseline touch/retest
- Strong indicator alignment
- Clear trend direction
- TP reached with room to spare

**Losing Trades:**
- Weak baseline retest (no wick rejection)
- Choppy price action around baseline
- AlphaTrend flat (no clear dominance)
- Premature SL hit due to volatility spike

**Common Issues:**
- **Overlapping SSL/PBEMA:** Indicates no flow - should be filtered
- **High RSI at entry:** Overbought/oversold rejection risk
- **Low ADX:** Ranging market, no clear trend
- **Tight SL:** Market noise can trigger premature exit

## Technical Details

### Indicator Calculations

| Indicator | Calculation | Purpose |
|-----------|-------------|---------|
| SSL Baseline | HMA(close, 60) | Trend direction, support/resistance |
| PBEMA Cloud | EMA(high, 200) & EMA(close, 200) | Take profit target zone |
| RSI | RSI(close, 14) | Momentum filter (overbought/oversold) |
| ADX | ADX(14) | Trend strength (min 25 for entry) |

### Data Fetching

The visualizer fetches OHLCV data from Binance Futures API:
- Time-based queries using `startTime`/`endTime`
- 75 candles before entry (context)
- 35 candles after exit (outcome visibility)
- Automatic retry with fallback strategies

### Performance

- Single trade: ~1-2 seconds
- Batch mode: ~25 trades in 30-40 seconds
- Chart size: ~380 KB at 300 DPI
- Memory usage: <100 MB for batch processing

## Troubleshooting

### "No data fetched" Error

**Cause:** Trade timestamp is too old or Binance API rate limit hit

**Solutions:**
- Use more recent trade data (last 6 months)
- Add delays between batch requests (automatic)
- Check Binance API status

### "Insufficient data after filtering" Warning

**Cause:** Not enough candles in the requested time window

**Solutions:**
- Reduce `--candles-before` and `--candles-after`
- Check if symbol was trading during that period
- Verify trade timestamps are correct

### "Failed to parse trade block" Warning

**Cause:** Unexpected format in trades_detailed.txt

**Solutions:**
- Ensure file is from a Rolling WF test
- Check for file corruption
- Regenerate trades_detailed.txt

## API Reference

### TradeVisualizer Class

```python
from core.trade_visualizer import TradeVisualizer

viz = TradeVisualizer(output_dir="trade_charts", dpi=300)

# Visualize single trade
chart_path = viz.visualize_trade(trade_dict)

# Batch visualize
chart_paths = viz.visualize_all_trades(trades_list)

# Interactive browser
viz.interactive_browser(trades_list)
```

### Trade Dictionary Format

```python
trade = {
    "symbol": "BTCUSDT-15m",
    "timeframe": "15m",
    "type": "LONG",  # or "SHORT"
    "open_time_utc": "2025-08-13T21:30:00Z",
    "close_time_utc": "2025-08-14T05:30:00Z",
    "entry": 42500.0,
    "tp": 43350.0,
    "sl": 42075.0,
    "close_price": 43350.0,
    "pnl": 35.50,
    "r_multiple": 2.0,
    "status": "WON",  # or "LOST"
    "indicators_at_entry": {
        "at_buyers": 42300.0,
        "at_sellers": 42100.0,
        "baseline": 42400.0,
        "pb_ema_top": 43200.0,
        "rsi": 55.0,
        "adx": 28.0,
    }
}
```

## Future Enhancements

Potential improvements:
- [ ] AlphaTrend visualization (buyers/sellers lines)
- [ ] Support for mplfinance candlestick library
- [ ] PDF report generation
- [ ] HTML interactive charts (plotly)
- [ ] Statistical overlays (win rate by hour, etc.)
- [ ] Custom indicator overlays
- [ ] Comparison mode (winning vs losing trades)

## Credits

- **Author:** Claude (Anthropic)
- **Date:** December 28, 2024
- **Project:** Desktop Bot Refactored v2 Base v7
- **Purpose:** Professional trade diagnosis and strategy validation

## License

Part of the Desktop Bot Trading System.
Internal use only.

---

**Need Help?**

Check the main project documentation:
- `/Users/emreoksuz/desktop_bot_refactored_v2_base_v7/CLAUDE.md`
- `/Users/emreoksuz/desktop_bot_refactored_v2_base_v7/run_rolling_wf_test.py`
